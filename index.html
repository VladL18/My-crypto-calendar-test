<!DOCTYPE html>
<html lang="uk">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>CRYPTODAY</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background-color: #000; color: #fff; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
    .calendar-container { display: flex; flex-direction: column; align-items: center; justify-content: flex-start; flex-grow: 1; overflow-y: auto; padding: 10px; width: 100%; box-sizing: border-box; }
    .month-display { font-size: 1.5em; font-weight: bold; margin-bottom: 10px; text-align: center; }
    table { width: 100%; max-width: 400px; border-collapse: collapse; margin: 0 auto; }
    th, td { width: 14.28%; height: 50px; text-align: center; vertical-align: middle; position: relative; color: #fff; }
    td .date-content { position: relative; z-index: 1; color: #fff; display: inline-block; width: 30px; height: 30px; line-height: 30px; box-sizing: border-box; }
    .dot { width: 6px; height: 6px; background-color: #fff; border-radius: 50%; position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%); z-index: 0; }
    .today { border: 2px solid #fff; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: auto; position: relative; z-index: 1; }
    .today .date-content { color: #fff; }
    .selected { background-color: #fff; border-radius: 50%; width: 30px; height: 30px; line-height: 30px; margin: auto; position: relative; z-index: 2; }
    .selected .date-content { color: #000; }
    .event-description { margin-top: 20px; font-size: 1.1em; background-color: #111; padding: 10px; border-radius: 10px; text-align: center; cursor: pointer; user-select: none; oncopy="return false;" }
    .tab-bar { display: flex !important; justify-content: space-around; background-color: #111; padding: 10px 0; border-top: 1px solid #333; position: fixed; bottom: 0; width: 100%; }
    .tab-button { text-align: center; flex: 1; font-size: 12px; color: #777; }
    .tab-button.active { color: #fff; }
    .tab-button span { display: block; font-size: 20px; color: #777; transition: color 0.3s; }
    .tab-button.active span { color: #fff; }
    .tab-button span::before { content: ''; display: inline-block; width: 20px; height: 20px; background-size: contain; background-repeat: no-repeat; }
    .tab-button:nth-child(1) span::before { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23444444"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>'); }
    .tab-button:nth-child(2) span::before { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23444444"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V7h14v12zM7 10h2v2H7v-2zm4 0h2v2h-2v-2zm4 0h2v2h-2v-2z"/></svg>'); }
    .tab-button:nth-child(3) span::before { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23444444"><path fill-rule="evenodd" clip-rule="evenodd" d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>'); }
    .tab-button:nth-child(4) span::before { background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%23444444"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.56-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.61 8.29c-.11.2-.06.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58c-.18.14-.23.41-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.11-.2.06-.47-.12-.61l-2.03-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>'); }
    .hidden { display: none; }
    .event-log { margin-top: 20px; width: 100%; max-width: 380px; margin-left: auto; margin-right: auto; }
    .event-entry { background-color: #1a1a1a; margin: 5px 0; padding: 12px; border-radius: 10px; position: relative; font-size: 16px; display: flex; justify-content: flex-start; align-items: center; color: #ccc; cursor: pointer; min-height: 50px; box-sizing: border-box; }
    .event-entry:hover { background-color: #2a2a2a; }
    .event-entry.selected { background-color: #fff; color: #000; border-radius: 10px; padding: 12px; margin: 5px 0; display: flex; justify-content: flex-start; align-items: center; width: 100%; min-height: 50px; box-sizing: border-box; }
    .event-entry.selected .event-date { color: #000; }
    .event-entry .event-date { font-weight: bold; color: #fff; display: flex; align-items: center; margin-right: 8px; min-width: 60px; }
    .event-entry span:nth-child(2) { overflow: hidden; text-overflow: ellipsis; line-height: 1.2; flex: 1; }
    .event-entry.long-text { display: flex; flex-direction: row; align-items: center; min-height: 50px; padding: 8px 12px; }
    .event-entry.long-text span:nth-child(2) { white-space: normal; line-height: 1.2; max-height: 96px; overflow: hidden; display: block; padding: 2px 0; flex: 1; }
    .event-entry.long-text.three-lines { min-height: 72px; }
    .event-entry.long-text.three-lines span:nth-child(2) { max-height: 72px; }
    .event-entry.long-text.four-lines { min-height: 96px; }
    .event-entry.long-text.four-lines span:nth-child(2) { max-height: 96px; }
    .event-entry.selected.long-text, .event-entry.selected.long-text.three-lines, .event-entry.selected.long-text.four-lines { min-height: 72px; min-height: 96px; }
    .event-entry.selected.long-text.three-lines { min-height: 72px; }
    .event-entry.selected.long-text.four-lines { min-height: 96px; }
    .event-entry.selected span:nth-child(2), .event-entry.selected.long-text span:nth-child(2) { line-height: 1.2; padding: 2px 0; }
    .event-entry .edit-btn { position: absolute; top: 5px; right: 5px; background: none; border: none; font-size: 16px; cursor: pointer; padding: 2px; z-index: 10; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
    .event-entry .edit-btn svg { fill: #444444; width: 100%; height: 100%; }
    .event-entry .edit-btn:hover svg { fill: #ccc; }
    .event-entry.pinned::after { content: '📌'; position: absolute; bottom: 5px; right: 5px; width: 16px; height: 16px; color: #444444; filter: grayscale(100%); font-size: 16px; line-height: 16px; text-align: center; z-index: 9; }
    .context-menu { display: none; position: fixed; background-color: #1a1a1a; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); z-index: 1001; width: 120px; padding: 5px 0; flex-direction: column; max-height: 170px; overflow-y: auto; pointer-events: auto; }
    .context-menu.active { display: flex; }
    .context-menu button { display: block; width: 100%; padding: 10px; background: none; border: none; color: #fff; font-size: 14px; text-align: left; cursor: pointer; position: relative; }
    .context-menu button:hover { background-color: #333; }
    .context-menu button.pinned::after, .context-menu button.notified::after { content: ''; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>'); background-size: contain; }
    .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 999; }
    .modal-overlay.active { display: block; }
    .modal { display: none; position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%); background-color: #1a1a1a; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); z-index: 1000; width: 80%; max-width: 350px; box-sizing: border-box; }
    .modal.active { display: flex; flex-direction: column; gap: 10px; pointer-events: auto; }
    .modal .close-btn { position: absolute; top: 0px; right: -3px; background: none; border: none; color: #fff; font-size: 19px; font-weight: bold; cursor: pointer; padding: 5px; line-height: 1; z-index: 1001; width: 25px; height: 25px; text-align: center; }
    .modal .close-btn:hover { color: #ccc; }
    .modal input, .modal button { padding: 10px; border-radius: 8px; border: none; background-color: #333; color: #fff; font-size: 14px; width: 100%; box-sizing: border-box; }
    .modal input[type="date"] { position: relative; appearance: none; -webkit-appearance: none; }
    .modal input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); }
    .modal button { background-color: #555; cursor: pointer; transition: background-color 0.3s; font-weight: bold; }
    .modal button:hover { background-color: #666; }
    .add-event-btn { margin-top: 20px; padding: 10px 20px; background-color: #444; border: none; border-radius: 6px; color: #fff; font-size: 14px; cursor: pointer; transition: background-color 0.3s; width: 100%; max-width: 400px; }
    .add-event-btn:hover { background-color: #555; }
    body.modal-open { overflow: hidden; position: fixed; width: 100%; height: 100%; }
    body.modal-open > *:not(#alertOverlay):not(#alertModal):not(#contextMenuOverlay):not(#contextMenu):not(#deleteConfirmOverlay):not(#deleteConfirmModal):not(#pinLimitOverlay):not(#pinLimitModal):not(.modal):not(.modal-overlay):not(#eventNotificationOverlay):not(#eventNotificationMenu):not(#exitMessage) { pointer-events: none; }
    body.modal-open .tab-bar { pointer-events: auto; } /* Дозволяємо взаємодію з вкладками */
    .event-input-container { position: relative; width: 100%; }
    .event-input-container input { padding-right: 30px; }
    .char-counter { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #aaa; font-size: 12px; }
    #alertOverlay, #contextMenuOverlay, #deleteConfirmOverlay, #pinLimitOverlay, #eventNotificationOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); z-index: 1001; pointer-events: auto; }
    #alertOverlay.active, #contextMenuOverlay.active, #deleteConfirmOverlay.active, #pinLimitOverlay.active, #eventNotificationOverlay.active { display: block; }
    #alertModal, #deleteConfirmModal, #pinLimitModal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: #1a1a1a; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5); z-index: 1002; width: 80%; max-width: 350px; box-sizing: border-box; text-align: center; pointer-events: auto; }
    #alertModal.active, #deleteConfirmModal.active, #pinLimitModal.active { display: block; }
    #alertModal p, #deleteConfirmModal p, #pinLimitModal p { margin: 0 0 15px 0; color: #fff; font-size: 14px; }
    #alertModal button, #deleteConfirmModal button, #pinLimitModal button { padding: 10px; border-radius: 8px; border: none; background-color: #555; color: #fff; font-size: 14px; cursor: pointer; transition: background-color 0.3s; margin: 0 5px; }
    #alertModal button:hover, #deleteConfirmModal button:hover, #pinLimitModal button:hover { background-color: #666; }
    #deleteConfirmModal .button-container { display: flex; justify-content: center; }
    /* Новий стиль для спалаху "CRYPTODAY" */
    #splash-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
      color: #fff;
      font-size: 2em; /* Середній розмір тексту */
      font-weight: 600; /* Трохи жирніший текст */
      opacity: 1;
      transition: opacity 0.5s ease-out;
    }
    #splash-screen.fade-out {
      opacity: 0;
      pointer-events: none;
    }
    #eventNotificationMenu {
      display: none;
      position: fixed;
      background-color: #1a1a1a;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
      z-index: 1002;
      width: 120px;
      padding: 5px 0;
      flex-direction: column;
      max-height: 50px;
      overflow-y: auto;
      pointer-events: auto;
      right: 20px;
      bottom: 40px; /* Піднято ще на 1 см (10px) від 30px */
    }
    #eventNotificationMenu.active {
      display: flex;
    }
    #eventNotificationMenu button {
      display: block;
      width: 100%;
      padding: 10px;
      background: none;
      border: none;
      color: #fff;
      font-size: 14px;
      text-align: left;
      cursor: pointer;
      position: relative;
    }
    #eventNotificationMenu button:hover {
      background-color: #333;
    }
    #eventNotificationMenu button.notified::after {
      content: '';
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      width: 12px;
      height: 12px;
      background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="%23ffffff" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M9 16.2L4.8 12l-1.4 1.4L9 19 21 7l-1.4-1.4L9 16.2z"/></svg>');
      background-size: contain;
    }
    #exitMessage {
      display: none;
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #1a1a1a;
      color: #fff;
      padding: 10px 20px;
      border-radius: 5px;
      z-index: 10000;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div id="splash-screen">CRYPTODAY</div>
  <div id="homeTab" class="calendar-container">
    <div class="month-display" id="monthDisplay"></div>
    <table>
      <thead>
        <tr><th>ПН</th><th>ВТ</th><th>СР</th><th>ЧТ</th><th>ПТ</th><th>СБ</th><th>НД</th></tr>
      </thead>
      <tbody id="calendarBody"></tbody>
    </table>
    <div class="event-description" id="eventDescription" oncopy="return false;">Оберіть дату, щоб дізнатися події.</div>
  </div>
  <div id="myCalendarTab" class="calendar-container hidden">
    <div class="month-display" id="myMonthDisplay"></div>
    <table>
      <thead>
        <tr><th>ПН</th><th>ВТ</th><th>СР</th><th>ЧТ</th><th>ПТ</th><th>СБ</th><th>НД</th></tr>
      </thead>
      <tbody id="myCalendarBody"></tbody>
    </table>
    <button class="add-event-btn" id="addEventBtn" onclick="toggleEventForm()">Додати подію</button>
    <div class="event-log" id="eventLog"></div>
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal" id="eventForm">
      <button class="close-btn" onclick="closeModal()">×</button>
      <input type="date" id="eventDateInput" />
      <div class="event-input-container">
        <input type="text" id="eventInput" placeholder="Опис події" maxlength="100" />
        <span class="char-counter" id="charCounter">100</span>
      </div>
      <button onclick="saveEvent()">Зберегти подію</button>
    </div>
    <div id="alertOverlay"></div>
    <div id="alertModal">
      <p id="alertMessage"></p>
      <button onclick="closeAlert()">OK</button>
    </div>
    <div id="contextMenuOverlay"></div>
    <div id="contextMenu" class="context-menu">
      <button onclick="editEvent()">Редагувати</button>
      <button onclick="pinEvent()" id="pinButton">Закріпити</button>
      <button onclick="toggleNotification()" id="notifyButton">Сповіщення</button>
      <button onclick="confirmDeleteEvent()">Видалити</button>
    </div>
    <div id="deleteConfirmOverlay"></div>
    <div id="deleteConfirmModal">
      <p>Чи точно ви хочете видалити цю подію?</p>
      <div class="button-container">
        <button onclick="deleteEvent()">Так</button>
        <button onclick="cancelDelete()">Ні</button>
      </div>
    </div>
    <div id="pinLimitOverlay"></div>
    <div id="pinLimitModal">
      <p>Максимальна кількість закріплених подій становить 364</p>
      <button onclick="closePinLimit()">OK</button>
    </div>
  </div>
  <div id="gratitudeTab" class="calendar-container hidden">
    <div class="month-display">Подяка ♥️</div>
  </div>
  <div id="settingsTab" class="calendar-container hidden">
    <div class="month-display">Налаштування</div>
    <button onclick="toggleTheme()">Перемкнути тему</button>
  </div>
  <div class="tab-bar">
    <div class="tab-button active" onclick="switchTab('homeTab', this)"><span></span>Головна</div>
    <div class="tab-button" onclick="switchTab('myCalendarTab', this)"><span></span>Мій календар</div>
    <div class="tab-button" onclick="switchTab('gratitudeTab', this)"><span></span>Подяка</div>
    <div class="tab-button" onclick="switchTab('settingsTab', this)"><span></span>Налаштування</div>
  </div>
  <div id="eventNotificationOverlay"></div>
  <div id="eventNotificationMenu" class="context-menu">
    <button onclick="toggleEventNotification()">Сповіщення</button>
  </div>
  <div id="exitMessage"></div>
  <script>
    const events = { '5-22': 'День Біткоїн Піци — перша покупка піци за BTC у 2010 році.', '1-3': 'День народження Біткоїна — запуск першого блоку в мережі Bitcoin у 2009 році.' };
    let myEvents = {};
    let pinnedEvents = [];
    let notificationsEnabled = {};
    let eventNotificationsEnabled = {};
    const todayStr = new Date().toLocaleString('en-US', { timeZone: 'Europe/Kyiv' });
    const today = new Date(todayStr);
    let currentMonth = today.getMonth();
    let currentYear = today.getFullYear();
    let scrollPosition = 0;
    let selectedDateKey = '';
    let editingDateKey = null;
    let holdTimeout = null;
    let backButtonPressCount = 0;
    let backButtonTimeout = null;

    document.addEventListener('DOMContentLoaded', () => {
      const tabBar = document.querySelector('.tab-bar');
      if (tabBar) {
        tabBar.style.display = 'flex'; // Гарантуємо відображення вкладок
      } else {
        console.error('Елемент .tab-bar не знайдено!');
      }
      initializeApp();
    });

    function initializeApp() {
      renderCalendar(currentMonth, currentYear, 'monthDisplay', 'calendarBody', true);
      renderCalendar(currentMonth, currentYear, 'myMonthDisplay', 'myCalendarBody');
      addSwipe('homeTab');
      addSwipe('myCalendarTab');
      setupEventDescriptionHold();
      scheduleEventNotifications();
      setupBackButtonHandler();
    }

    function renderCalendar(month, year, containerId, bodyId, isMain = false) {
      const monthDisplay = document.getElementById(containerId);
      const calendarBody = document.getElementById(bodyId);
      const eventDescription = document.getElementById('eventDescription');
      calendarBody.innerHTML = '';
      const firstDay = new Date(year, month).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const startDay = (firstDay + 6) % 7;
      const monthNames = ['Січень', 'Лютий', 'Березень', 'Квітень', 'Травень', 'Червень', 'Липень', 'Серпень', 'Вересень', 'Жовтень', 'Листопад', 'Грудень'];
      monthDisplay.textContent = `${monthNames[month]} ${year}`;
      let date = 1;
      for (let i = 0; i < 6; i++) {
        const row = document.createElement('tr');
        for (let j = 0; j < 7; j++) {
          const cell = document.createElement('td');
          if (i === 0 && j < startDay) cell.textContent = '';
          else if (date > daysInMonth) break;
          else {
            const dateSpan = document.createElement('span');
            dateSpan.className = 'date-content';
            dateSpan.textContent = date;
            cell.appendChild(dateSpan);
            const key = `${month + 1}-${date}`;
            if (isMain && events[key]) {
              const dot = document.createElement('div');
              dot.classList.add('dot');
              cell.appendChild(dot);
            } else if (!isMain && myEvents[key]) {
              const dot = document.createElement('div');
              dot.classList.add('dot');
              cell.appendChild(dot);
            }
            if (date === today.getDate() && month === today.getMonth() && year === today.getFullYear()) cell.classList.add('today');
            if (!isMain && key === selectedDateKey && parseInt(key.split('-')[0]) - 1 === month) cell.classList.add('selected');
            else if (isMain && key === selectedDateKey && parseInt(key.split('-')[0]) - 1 === month) cell.classList.add('selected');
            cell.addEventListener('click', () => {
              const cells = calendarBody.querySelectorAll('td');
              const isSelected = cell.classList.contains('selected');
              cells.forEach(c => c.classList.remove('selected'));
              if (!isSelected) {
                cell.classList.add('selected');
                selectedDateKey = key;
              } else {
                selectedDateKey = '';
                eventDescription.textContent = 'Оберіть дату, щоб дізнатися події.';
              }
              if (isMain) eventDescription.textContent = selectedDateKey && events[selectedDateKey] ? events[selectedDateKey] : 'Оберіть дату, щоб дізнатися події.';
              else {
                const log = document.getElementById('eventLog');
                const entries = log.querySelectorAll('.event-entry');
                entries.forEach(entry => entry.classList.remove('selected'));
                if (!isSelected && myEvents[key]) entries.forEach(entry => { if (entry.dataset.dateKey === key) entry.classList.add('selected'); });
              }
            });
            date++;
          }
          row.appendChild(cell);
        }
        calendarBody.appendChild(row);
      }
      if (isMain && !selectedDateKey) eventDescription.textContent = 'Оберіть дату, щоб дізнатися події.';
      else if (isMain && selectedDateKey && events[selectedDateKey]) eventDescription.textContent = events[selectedDateKey];
    }

    function toggleEventForm() {
      const eventForm = document.getElementById('eventForm');
      const modalOverlay = document.getElementById('modalOverlay');
      const body = document.body;
      eventForm.classList.toggle('active');
      modalOverlay.classList.toggle('active');
      if (eventForm.classList.contains('active')) {
        scrollPosition = window.pageYOffset;
        body.classList.add('modal-open');
        const todayDate = new Date().toLocaleDateString('fr-CA', { timeZone: 'Europe/Kyiv' });
        document.getElementById('eventDateInput').value = todayDate;
        document.getElementById('eventInput').value = '';
        editingDateKey = null;
        updateCharCounter();
      } else {
        body.classList.remove('modal-open');
        window.scrollTo(0, scrollPosition);
      }
    }

    function closeModal() {
      const eventForm = document.getElementById('eventForm');
      const modalOverlay = document.getElementById('modalOverlay');
      const body = document.body;
      eventForm.classList.remove('active');
      modalOverlay.classList.remove('active');
      body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
      document.getElementById('eventInput').value = '';
      editingDateKey = null;
      updateCharCounter();
    }

    function updateCharCounter() {
      const eventInput = document.getElementById('eventInput');
      const charCounter = document.getElementById('charCounter');
      let text = eventInput.value;
      const charCount = text.length;
      const remaining = 100 - charCount;
      charCounter.textContent = Math.max(0, remaining);
      if (charCount > 100) {
        let trimmedText = '';
        let count = 0;
        for (let i = 0; i < text.length && count < 100; i++) {
          trimmedText += text[i];
          count++;
        }
        eventInput.value = trimmedText;
        charCounter.textContent = 0;
      }
    }

    function saveEvent() {
      const date = document.getElementById('eventDateInput').value;
      const text = document.getElementById('eventInput').value.trim();
      if (text && date && text.length <= 100) {
        const newDateKey = `${new Date(date).getMonth() + 1}-${new Date(date).getDate()}`;
        if (!editingDateKey && myEvents[newDateKey]) {
          showAlert('На цей день уже є подія! Можна додавати лише одну подію на день.');
          return;
        }
        if (editingDateKey && newDateKey !== editingDateKey && myEvents[newDateKey]) {
          showAlert('На цей день уже є подія! Можна додавати лише одну подію на день.');
          return;
        }
        if (Object.keys(myEvents).length >= 365 && !editingDateKey) {
          showAlert('Досягнуто максимальну кількість подій (365)!');
          return;
        }
        if (editingDateKey) {
          delete myEvents[editingDateKey];
          const index = pinnedEvents.indexOf(editingDateKey);
          if (index !== -1) pinnedEvents.splice(index, 1);
          if (notificationsEnabled[editingDateKey]) delete notificationsEnabled[editingDateKey];
        }
        myEvents[newDateKey] = text;
        document.getElementById('eventInput').value = '';
        document.getElementById('eventForm').classList.remove('active');
        document.getElementById('modalOverlay').classList.remove('active');
        document.body.classList.remove('modal-open');
        window.scrollTo(0, scrollPosition);
        editingDateKey = null;
        updateEventLog();
        renderCalendar(currentMonth, currentYear, 'myMonthDisplay', 'myCalendarBody');
        scheduleNotifications();
      }
    }

    function updateEventLog() {
      const log = document.getElementById('eventLog');
      log.innerHTML = '';
      const sortedDates = Object.keys(myEvents).sort((a, b) => {
        const aIsPinned = pinnedEvents.includes(a);
        const bIsPinned = pinnedEvents.includes(b);
        if (aIsPinned && bIsPinned) return pinnedEvents.indexOf(b) - pinnedEvents.indexOf(a);
        if (aIsPinned) return -1;
        if (bIsPinned) return 1;
        const [aMonth, aDay] = a.split('-').map(Number);
        const [bMonth, bDay] = b.split('-').map(Number);
        return new Date(currentYear, aMonth - 1, aDay) - new Date(currentYear, bMonth - 1, bDay);
      });
      for (let date of sortedDates) {
        const entry = document.createElement('div');
        entry.className = 'event-entry';
        if (pinnedEvents.includes(date)) entry.classList.add('pinned');
        const dateSpan = document.createElement('span');
        dateSpan.className = 'event-date';
        dateSpan.textContent = formatDate(date);
        const textSpan = document.createElement('span');
        textSpan.textContent = myEvents[date];
        const editBtn = document.createElement('button');
        editBtn.className = 'edit-btn';
        editBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>`;
        editBtn.onclick = (e) => { e.stopPropagation(); showContextMenu(date, e); };
        const lineHeight = 1.2 * 16;
        const lines = Math.ceil(myEvents[date].length / 20);
        if (lines >= 3) {
          entry.classList.add('long-text');
          if (lines === 3) entry.classList.add('three-lines');
          else if (lines >= 4) entry.classList.add('four-lines');
        }
        entry.appendChild(dateSpan);
        entry.appendChild(textSpan);
        entry.appendChild(editBtn);
        entry.dataset.dateKey = date;
        if (date === selectedDateKey) entry.classList.add('selected');
        entry.addEventListener('click', () => {
          const isSelected = entry.classList.contains('selected');
          const entries = log.querySelectorAll('.event-entry');
          entries.forEach(e => e.classList.remove('selected'));
          const calendarBody = document.getElementById('myCalendarBody');
          const cells = calendarBody.querySelectorAll('td');
          cells.forEach(c => c.classList.remove('selected'));
          if (!isSelected) {
            entry.classList.add('selected');
            selectedDateKey = date;
            const [month, day] = date.split('-');
            currentMonth = parseInt(month) - 1;
            renderCalendar(currentMonth, currentYear, 'myMonthDisplay', 'myCalendarBody');
            cells.forEach(cell => { if (parseInt(cell.textContent) === parseInt(day)) cell.classList.add('selected'); });
          } else selectedDateKey = '';
        });
        log.appendChild(entry);
      }
    }

    function formatDate(key) {
      const [m, d] = key.split('-');
      return `${d.padStart(2, '0')}.${m.padStart(2, '0')}.${currentYear}`;
    }

    function showContextMenu(dateKey, event) {
      const contextMenu = document.getElementById('contextMenu');
      const contextMenuOverlay = document.getElementById('contextMenuOverlay');
      const body = document.body;
      contextMenu.dataset.dateKey = dateKey;
      const pinButton = document.getElementById('pinButton');
      const notifyButton = document.getElementById('notifyButton');
      if (pinnedEvents.includes(dateKey)) pinButton.classList.add('pinned');
      else pinButton.classList.remove('pinned');
      if (notificationsEnabled[dateKey]) notifyButton.classList.add('notified');
      else notifyButton.classList.remove('notified');
      let x = event.clientX;
      let y = event.clientY - 100;
      const menuWidth = 120;
      const menuHeight = 170;
      const windowWidth = window.innerWidth;
      const windowHeight = window.innerHeight;
      if (x + menuWidth > windowWidth) x = windowWidth - menuWidth - 10;
      if (y + menuHeight > windowHeight) y = windowHeight - menuHeight - 10;
      if (x < 0) x = 10;
      if (y < 0) y = 10;
      contextMenu.style.left = `${x}px`;
      contextMenu.style.top = `${y}px`;
      contextMenu.classList.add('active');
      contextMenuOverlay.classList.add('active');
      body.classList.add('modal-open');
      scrollPosition = window.pageYOffset;
    }

    function editEvent() {
      const contextMenu = document.getElementById('contextMenu');
      const dateKey = contextMenu.dataset.dateKey;
      const eventForm = document.getElementById('eventForm');
      const modalOverlay = document.getElementById('modalOverlay');
      const body = document.body;
      contextMenu.classList.remove('active');
      document.getElementById('contextMenuOverlay').classList.remove('active');
      eventForm.classList.add('active');
      modalOverlay.classList.add('active');
      body.classList.add('modal-open');
      const [month, day] = dateKey.split('-');
      const eventDate = new Date(currentYear, parseInt(month) - 1, parseInt(day));
      const formattedDate = eventDate.toLocaleDateString('fr-CA', { timeZone: 'Europe/Kyiv' });
      document.getElementById('eventDateInput').value = formattedDate;
      document.getElementById('eventInput').value = myEvents[dateKey];
      editingDateKey = dateKey;
      updateCharCounter();
    }

    function pinEvent() {
      const contextMenu = document.getElementById('contextMenu');
      const dateKey = contextMenu.dataset.dateKey;
      const index = pinnedEvents.indexOf(dateKey);
      if (index === -1) {
        if (pinnedEvents.length >= 364) {
          showPinLimit();
          return;
        }
        pinnedEvents.unshift(dateKey);
      } else {
        pinnedEvents.splice(index, 1);
      }
      contextMenu.classList.remove('active');
      document.getElementById('contextMenuOverlay').classList.remove('active');
      document.body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
      updateEventLog();
    }

    function toggleNotification() {
      const contextMenu = document.getElementById('contextMenu');
      const dateKey = contextMenu.dataset.dateKey;
      if (notificationsEnabled[dateKey]) delete notificationsEnabled[dateKey];
      else notificationsEnabled[dateKey] = true;
      contextMenu.classList.remove('active');
      document.getElementById('contextMenuOverlay').classList.remove('active');
      document.body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
      updateEventLog();
      scheduleNotifications();
    }

    function scheduleNotifications() {
      const now = new Date();
      for (const dateKey in notificationsEnabled) {
        const [month, day] = dateKey.split('-').map(Number);
        const eventDate = new Date(currentYear, month - 1, day);
        const notificationTime = new Date(eventDate);
        notificationTime.setHours(8, 0, 0, 0);
        if (notificationTime > now) {
          const timeDiff = notificationTime - now;
          setTimeout(() => {
            if (Notification.permission === 'granted') {
              new Notification('У вас сьогодні подія!', {
                body: 'Натисніть щоб переглянути',
                data: { dateKey },
                tag: `event-${dateKey}`,
              }).onclick = (e) => {
                e.preventDefault();
                const myCalendarTabButton = document.querySelector('.tab-button:nth-child(2)');
                switchTab('myCalendarTab', myCalendarTabButton, dateKey);
              };
            }
          }, timeDiff);
        }
      }
    }

    function confirmDeleteEvent() {
      const contextMenu = document.getElementById('contextMenu');
      const dateKey = contextMenu.dataset.dateKey;
      const deleteConfirmModal = document.getElementById('deleteConfirmModal');
      const deleteConfirmOverlay = document.getElementById('deleteConfirmOverlay');
      const body = document.body;
      contextMenu.classList.remove('active');
      document.getElementById('contextMenuOverlay').classList.remove('active');
      deleteConfirmModal.dataset.dateKey = dateKey;
      deleteConfirmModal.classList.add('active');
      deleteConfirmOverlay.classList.add('active');
      body.classList.add('modal-open');
    }

    function deleteEvent() {
      const deleteConfirmModal = document.getElementById('deleteConfirmModal');
      const dateKey = deleteConfirmModal.dataset.dateKey;
      delete myEvents[dateKey];
      const index = pinnedEvents.indexOf(dateKey);
      if (index !== -1) pinnedEvents.splice(index, 1);
      if (notificationsEnabled[dateKey]) delete notificationsEnabled[dateKey];
      deleteConfirmModal.classList.remove('active');
      document.getElementById('deleteConfirmOverlay').classList.remove('active');
      document.body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
      updateEventLog();
      renderCalendar(currentMonth, currentYear, 'myMonthDisplay', 'myCalendarBody');
      selectedDateKey = '';
    }

    function cancelDelete() {
      const deleteConfirmModal = document.getElementById('deleteConfirmModal');
      deleteConfirmModal.classList.remove('active');
      document.getElementById('deleteConfirmOverlay').classList.remove('active');
      document.body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
    }

    function switchTab(tabId, element, dateKey = null) {
      document.querySelectorAll('.calendar-container').forEach(el => el.classList.add('hidden'));
      document.getElementById(tabId).classList.remove('hidden');
      document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
      element.classList.add('active');
      if (tabId === 'myCalendarTab' && dateKey) {
        selectedDateKey = dateKey;
        const [month, day] = dateKey.split('-');
        currentMonth = parseInt(month) - 1;
        renderCalendar(currentMonth, currentYear, 'myMonthDisplay', 'myCalendarBody');
        const calendarBody = document.getElementById('myCalendarBody');
        const cells = calendarBody.querySelectorAll('td');
        cells.forEach(cell => { if (parseInt(cell.textContent) === parseInt(day)) cell.classList.add('selected'); });
        const log = document.getElementById('eventLog');
        const entries = log.querySelectorAll('.event-entry');
        entries.forEach(entry => { if (entry.dataset.dateKey === dateKey) entry.classList.add('selected'); });
      }
    }

    function toggleTheme() {
      const body = document.body;
      const isDark = body.style.backgroundColor === 'black';
      body.style.backgroundColor = isDark ? '#fff' : '#000';
      body.style.color = isDark ? '#000' : '#fff';
    }

    function addSwipe(containerId) {
      const container = document.getElementById(containerId);
      let touchStartX = 0;
      container.addEventListener('touchstart', e => {
        const eventForm = document.getElementById('eventForm');
        const alertModal = document.getElementById('alertModal');
        const contextMenu = document.getElementById('contextMenu');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const pinLimitModal = document.getElementById('pinLimitModal');
        const eventNotificationMenu = document.getElementById('eventNotificationMenu');
        if (eventForm.classList.contains('active') || alertModal.classList.contains('active') || contextMenu.classList.contains('active') || deleteConfirmModal.classList.contains('active') || pinLimitModal.classList.contains('active') || eventNotificationMenu.classList.contains('active')) return;
        touchStartX = e.touches[0].screenX;
      });
      container.addEventListener('touchend', e => {
        const eventForm = document.getElementById('eventForm');
        const alertModal = document.getElementById('alertModal');
        const contextMenu = document.getElementById('contextMenu');
        const deleteConfirmModal = document.getElementById('deleteConfirmModal');
        const pinLimitModal = document.getElementById('pinLimitModal');
        const eventNotificationMenu = document.getElementById('eventNotificationMenu');
        if (eventForm.classList.contains('active') || alertModal.classList.contains('active') || contextMenu.classList.contains('active') || deleteConfirmModal.classList.contains('active') || pinLimitModal.classList.contains('active') || eventNotificationMenu.classList.contains('active')) return;
        const diffX = e.changedTouches[0].screenX - touchStartX;
        if (Math.abs(diffX) > 50) {
          if (diffX < 0) {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
          } else {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
          }
          renderCalendar(currentMonth, currentYear, 'monthDisplay', 'calendarBody', true);
          renderCalendar(currentMonth, currentYear, 'myMonthDisplay', 'myCalendarBody');
        }
      });
    }

    function showAlert(message) {
      const alertModal = document.getElementById('alertModal');
      const alertOverlay = document.getElementById('alertOverlay');
      const alertMessage = document.getElementById('alertMessage');
      const body = document.body;
      alertMessage.textContent = message;
      alertModal.classList.add('active');
      alertOverlay.classList.add('active');
      body.classList.add('modal-open');
      scrollPosition = window.pageYOffset;
    }

    function closeAlert() {
      const alertModal = document.getElementById('alertModal');
      const alertOverlay = document.getElementById('alertOverlay');
      const eventForm = document.getElementById('eventForm');
      const modalOverlay = document.getElementById('modalOverlay');
      const body = document.body;
      if (alertModal.classList.contains('active')) {
        alertModal.classList.remove('active');
        alertOverlay.classList.remove('active');
        eventForm.classList.add('active');
        modalOverlay.classList.add('active');
        body.classList.add('modal-open');
        window.scrollTo(0, scrollPosition);
        scrollPosition = 0;
      }
    }

    function showPinLimit() {
      const pinLimitModal = document.getElementById('pinLimitModal');
      const pinLimitOverlay = document.getElementById('pinLimitOverlay');
      const body = document.body;
      pinLimitModal.classList.add('active');
      pinLimitOverlay.classList.add('active');
      body.classList.add('modal-open');
      scrollPosition = window.pageYOffset;
    }

    function closePinLimit() {
      const pinLimitModal = document.getElementById('pinLimitModal');
      const pinLimitOverlay = document.getElementById('pinLimitOverlay');
      const body = document.body;
      pinLimitModal.classList.remove('active');
      pinLimitOverlay.classList.remove('active');
      body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
    }

    function setupEventDescriptionHold() {
      const eventDescription = document.getElementById('eventDescription');
      let holdStartTime = null;

      eventDescription.addEventListener('mousedown', (e) => {
        holdStartTime = Date.now();
        holdTimeout = setTimeout(() => {
          if (Date.now() - holdStartTime >= 500 && selectedDateKey && events[selectedDateKey]) {
            showEventNotificationMenu(selectedDateKey, e);
          }
        }, 500);
      });

      eventDescription.addEventListener('mouseup', () => {
        clearTimeout(holdTimeout);
      });

      eventDescription.addEventListener('mouseleave', () => {
        clearTimeout(holdTimeout);
      });

      eventDescription.addEventListener('touchstart', (e) => {
        holdStartTime = Date.now();
        holdTimeout = setTimeout(() => {
          if (Date.now() - holdStartTime >= 500 && selectedDateKey && events[selectedDateKey]) {
            showEventNotificationMenu(selectedDateKey, e);
          }
        }, 500);
      });

      eventDescription.addEventListener('touchend', () => {
        clearTimeout(holdTimeout);
      });

      eventDescription.addEventListener('touchcancel', () => {
        clearTimeout(holdTimeout);
      });
    }

    function showEventNotificationMenu(dateKey, event) {
      const eventNotificationMenu = document.getElementById('eventNotificationMenu');
      const eventNotificationOverlay = document.getElementById('eventNotificationOverlay');
      const body = document.body;
      eventNotificationMenu.dataset.dateKey = dateKey;
      const notifyButton = eventNotificationMenu.querySelector('button');
      if (eventNotificationsEnabled[dateKey]) notifyButton.classList.add('notified');
      else notifyButton.classList.remove('notified');
      eventNotificationMenu.style.right = '20px';
      eventNotificationMenu.style.bottom = '40px';
      eventNotificationMenu.classList.add('active');
      eventNotificationOverlay.classList.add('active');
      body.classList.add('modal-open');
      scrollPosition = window.pageYOffset;
    }

    function toggleEventNotification() {
      const eventNotificationMenu = document.getElementById('eventNotificationMenu');
      const dateKey = eventNotificationMenu.dataset.dateKey;
      if (eventNotificationsEnabled[dateKey]) delete eventNotificationsEnabled[dateKey];
      else eventNotificationsEnabled[dateKey] = true;
      eventNotificationMenu.classList.remove('active');
      document.getElementById('eventNotificationOverlay').classList.remove('active');
      document.body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
      scheduleEventNotifications();
    }

    function scheduleEventNotifications() {
      const now = new Date();
      for (const dateKey in eventNotificationsEnabled) {
        const [month, day] = dateKey.split('-').map(Number);
        const eventDate = new Date(currentYear, month - 1, day);
        const notificationTime = new Date(eventDate);
        notificationTime.setUTCHours(5, 0, 0, 0); // 8:00 EEST (UTC+3)
        if (notificationTime > now) {
          const timeDiff = notificationTime - now;
          setTimeout(() => {
            if (Notification.permission === 'granted') {
              new Notification('Сьогодні важлива криптоподія!', {
                body: 'натисніть щоб переглянути',
                data: { dateKey },
                tag: `event-notification-${dateKey}`,
                icon: null,
                badge: null,
                style: {
                  color: '#fff',
                  bodyColor: '#888',
                },
              }).onclick = (e) => {
                e.preventDefault();
                const homeTabButton = document.querySelector('.tab-button:nth-child(1)');
                switchTab('homeTab', homeTabButton);
                selectedDateKey = dateKey;
                renderCalendar(currentMonth, currentYear, 'monthDisplay', 'calendarBody', true);
                document.getElementById('eventDescription').textContent = events[dateKey];
              };
            }
          }, timeDiff);
        }
      }
    }

    function setupBackButtonHandler() {
      document.addEventListener('backbutton', () => {
        if (backButtonPressCount === 0) {
          const exitMessage = document.getElementById('exitMessage');
          exitMessage.textContent = 'Щоб вийти натисніть ще раз';
          exitMessage.style.display = 'block';
          backButtonPressCount = 1;
          backButtonTimeout = setTimeout(() => {
            exitMessage.style.display = 'none';
            backButtonPressCount = 0;
          }, 1000);
        } else if (backButtonPressCount === 1) {
          clearTimeout(backButtonTimeout);
          document.getElementById('exitMessage').style.display = 'none';
          window.close();
        }
      });
    }

    document.getElementById('eventNotificationOverlay').addEventListener('click', () => {
      const eventNotificationMenu = document.getElementById('eventNotificationMenu');
      eventNotificationMenu.classList.remove('active');
      document.getElementById('eventNotificationOverlay').classList.remove('active');
      document.body.classList.remove('modal-open');
      window.scrollTo(0, scrollPosition);
    });

    document.addEventListener('DOMContentLoaded', () => {
      const eventInput = document.getElementById('eventInput');
      eventInput.addEventListener('input', updateCharCounter);
      document.getElementById('contextMenuOverlay').addEventListener('click', () => {
        document.getElementById('contextMenu').classList.remove('active');
        document.getElementById('contextMenuOverlay').classList.remove('active');
        document.body.classList.remove('modal-open');
        window.scrollTo(0, scrollPosition);
      });
      if (Notification.permission !== 'granted') Notification.requestPermission();
      showSplashScreen();
    });
  </script>
</body>
</html>
